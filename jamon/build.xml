<?xml version="1.0"?>

<project name="meta" default="jar">

  <description>
    Meta build script for Jamon.  From this script one can
    compile the Jamon engine (project 'core') and the exercise it (project
    'integration').
  </description>

  <property file="build.properties"/>
  <property file="${user.home}/.ant.properties"/>
  <property name="jarfile" value="jamon.jar" />
  <property name="core.classes.dir" value="core/build/classes" />

  <target name="test"
          depends="jar"
          description="Run the demo">
    <ant dir="integration" target="test"/>
  </target>

  <target name="core" description="Build the core template engine">
    <ant dir="core" target="compile"/>
  </target>

  <target name="compile" description="Build every project">
    <ant dir="core" target="compile"/>
    <ant dir="anttask" target="compile"/>
    <ant dir="stdlib" target="compile"/>
  </target>

  <target name="jar"
          description="Creates a uber JAR"
          depends="compile">
    <jar jarfile="${jarfile}"
         manifest="manifest" >
      <fileset dir="core/build/classes" />
      <fileset dir="stdlib/build/classes" />
      <fileset dir="anttask/build/classes" />
    </jar>
  </target>

  <target name="cvsignores" description="Generates cvsignore files">
    <ant dir="core" target="cvsignores"/>
    <ant dir="integration" target="cvsignores"/>
    <ant dir="anttask" target="cvsignores"/>
    <ant dir="stdlib" target="cvsignores"/>
    <echo file=".cvsignore">.cvsignore ${jarfile}
</echo>
  </target>

  <target name="spotless">
    <ant dir="core" target="spotless"/>
    <ant dir="integration" target="spotless"/>
    <ant dir="anttask" target="spotless"/>
    <ant dir="stdlib" target="spotless"/>
    <delete file="${jarfile}" />
    <delete file=".cvsignore" />
  </target>

  <target name="clean">
    <ant dir="core" target="clean"/>
    <ant dir="integration" target="clean"/>
    <ant dir="stdlib" target="clean"/>
    <ant dir="anttask" target="clean"/>
  </target>

  <target name="release" depends="core">
    <exec executable="java"
          outputproperty="currentversion">
      <arg value="-cp" />
      <arg value="${core.classes.dir}" />
      <arg value="org.jamon.ShowVersion" />
      <arg value="minor" />
    </exec>
    <exec executable="java"
          outputproperty="majorversion">
      <arg value="-cp" />
      <arg value="${core.classes.dir}" />
      <arg value="org.jamon.ShowVersion" />
      <arg value="major" />
    </exec>
    <exec executable="java"
          outputproperty="nextversion">
      <arg value="-cp" />
      <arg value="${core.classes.dir}" />
      <arg value="org.jamon.ShowVersion" />
      <arg value="nextminor" />
    </exec>
    <echo message="Current version: ${majorversion}.${currentversion}" />
    <echo message="Next version: ${majorversion}.${nextversion}" />
    <property name="file" value="core/src/org/jamon/Resources.properties" />
    <cvs command="edit ${file}"/>
    <replace file="${file}"
             token="minor=${currentversion}"
             value="minor=${nextversion}" />
    <replace file="${file}"
             token="release=false"
             value="release=true" />
    <cvs command="commit -m 'minor version bump to ${currentversion}' ${file}" />
    <cvs command="tag RELEASE-${majorversion}_${nextversion}" />
    <cvs command="edit ${file}"/>
    <replace file="${file}"
             token="release=true"
             value="release=false" />
    <cvs command="commit -m 'dev version of ${currentversion}' ${file}" />
  </target>

</project>
