<?xml version="1.0"?>

<project name="Jamon Integration Tests" default="compile">
    <description>Integration Tests for the Jamon template engine</description>

    <property name="org.jamon.integration.verbose" value="false"/>

    <property name="build.src.dir" value="${basedir}/../../target/integration-src"/>
    <property name="classes.dir" value="${basedir}/../../target/integration-classes"/>
    <property name="src.dir" value="java"/>

    <property name="sample.template1" value="test/jamon/TestTemplate"/>
    <property name="sample.template2" value="test/jamon/Arguments"/>

    <property name="junit.timeout" value="15000"/>
    <property name="junit.printsummary" value="off"/>
    <property name="junit.formatter" value="org.apache.tools.ant.taskdefs.optional.junit.BriefJUnitResultFormatter"/>

    <property name="tests.compiler" value="${build.compiler}"/>
    <property name="tests" value="*Test"/>

    <property name="java.lib.jamon" value="${maven.runtime.classpath}"/>

    <target name="template-src">
        <echo file="templates/test/jamon/Recompilation.jamon" append="false">This is the template</echo>
        <echo>File created</echo>
    </target>

    <target name="templates" depends="template-src">
        <mkdir dir="${build.src.dir}"/>
        <java failonerror="true" classname="org.jamon.compiler.TemplateProcessor">
            <classpath>
                <path  refid="maven.runtime.classpath"/>
                <path location="${classes.dir}"/>
            </classpath>
            <arg value="--destDir=${build.src.dir}"/>
            <arg value="--srcDir=${basedir}/templates"/>
            <arg value="--directories"/>
            <arg value="/test/jamon"/>
            <arg value="/test/jamon/aliasProperties"/>
            <arg value="/test/jamon/context"/>
            <arg value="/test/jamon/subdir"/>
        </java>
        <java failonerror="true" classname="org.jamon.compiler.TemplateProcessor" classpath="${maven.runtime.classpath}">
            <classpath refid="maven.runtime.classpath"/>
            <arg value="--destDir=${build.src.dir}"/>
            <arg value="--srcDir=${basedir}/libTemplates"/>
            <arg value="--directories"/>
            <arg value="/test/jamon"/>
        </java>
    </target>

    <target name="compile" depends="templates" description="Compiles Java">
        <dependset>
            <srcfileset dir="${src.dir}" includes="**/*.java"/>
            <srcfileset dir="${build.src.dir}" includes="**/*.java"/>
            <targetfileset dir="${classes.dir}" includes="**/*.class"/>
        </dependset>
        <delete dir="${build.dir}/src/test/jamon/broken"/>
        <mkdir dir="${classes.dir}"/>
        <javac destdir="${classes.dir}" debug="true" deprecation="true">
            <classpath refid="maven.test.classpath"/>
            <src path="${src.dir}"/>
            <src path="${build.src.dir}"/>
        </javac>
    </target>

    <target name="test" depends="compile" description="Run the integration tests">
        <delete dir="${build.dir}/work"/>
        <dirname property="template.src.dir" file="${ant.file}"/>
        <property name="build.sysclasspath" value="last"/>
        <path id="org.jamon.integration.classpath">
            <pathelement path="${java.lib.jamon}"/>
            <pathelement location="${template.src.dir}/${classes.dir}"/>
        </path>
        <property name="org.jamon.integration.classpath" refid="org.jamon.integration.classpath"/>
        <condition property="org.jamon.integration.compiler" value="javac">
            <not>
                <equals arg1="${tests.compiler}" arg2="jikes"/>
            </not>
        </condition>
        <taskdef name="junit" classpathref="maven.test.classpath" classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask"/>
        <junit printsummary="${junit.printsummary}" timeout="${junit.timeout}" failureproperty="org.jamon.junit.failuresOccured">
            <sysproperty key="org.jamon.integration.basedir" value="${template.src.dir}"/>
            <!--
            <sysproperty key="org.jamon.integration.compiler" value="${org.jamon.integration.compiler}"/>
            <sysproperty key="org.jamon.integration.classpath" value="${org.jamon.integration.classpath}"/>
            <sysproperty key="org.jamon.integration.verbose" value="${org.jamon.integration.verbose}"/>
            -->
            <formatter classname="${junit.formatter}" usefile="no"/>
            <classpath>
                <path refid="maven.test.classpath"/>
                <pathelement location="${classes.dir}"/>
            </classpath>
            <batchtest>
                <fileset dir="${src.dir}">
                    <include name="**/${tests}.java"/>
                </fileset>
            </batchtest>
        </junit>
        <fail message="tests failed" if="org.jamon.junit.failuresOccured"/>
    </target>

</project>
